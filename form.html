<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø±Ø©</title>
  <style>
    * { box-sizing: border-box; }
    body {
      background: url('https://i.postimg.cc/JhKnMv57/FB-IMG-1753464094985.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Tahoma', sans-serif;
      margin: 0; padding: 0;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh;
    }
    .container {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(5px);
      max-width: 500px; width: 90%;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      padding: 20px;
    }
    .step { display: none; }
    .step.active { display: block; }
    input, select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
    h2 { text-align: center; color: #222; font-size: 1.5rem; margin-bottom: 20px; background: rgba(255,255,255,0.4); padding:10px; border-radius:8px; backdrop-filter: blur(4px);}
    label { display: block; font-weight: bold; color: #222; background: rgba(255,255,255,0.6); padding:5px 10px; border-radius:6px; margin-top:15px; backdrop-filter: blur(4px);}
    button { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; background: #007bff; color: white; font-size:1rem; margin-top:10px; transition: 0.3s; }
    button:hover { background: #0056b3; }
    .buttons { display: flex; justify-content: space-between; gap:10px; }
    .remove-companion-btn { background:red; color:white; padding:5px 10px; border-radius:5px; border:none; cursor:pointer; margin-top:5px; }
    .popup-box { display: none; text-align: center; padding: 20px; background: rgba(255,255,255,0.9); margin: 30px auto; max-width: 500px; border-radius: 15px; box-shadow: 0 0 15px rgba(0,0,0,0.2); backdrop-filter: blur(6px); color: #222; font-size: 18px; position: relative; z-index: 1000;}
    .popup-box h3 { font-size:22px; font-weight:bold; margin-bottom:15px; background: rgba(255,255,255,0.6); padding:12px; border-radius:10px; backdrop-filter: blur(3px);}
    .popup-box p { font-size:17px; color:#444; margin:10px 0; }
    .popup-box button { margin:8px; padding:10px 20px; border:none; border-radius:8px; background:#007bff; color:white; font-weight:bold; font-size:16px; cursor:pointer; }
    .popup-box button:hover { background:#0056b3; }
    @media (max-width:480px) { .container { padding:15px;} h2 { font-size:1.3rem;} input, select, button { font-size:0.95rem; padding:10px;} }
  </style>
</head>
<body>

<form id="umrahForm" class="container">

  <!-- Ø§Ù„Ø®Ø·ÙˆØ© 1 -->
  <div class="step active">
    <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§ÙØ±</h2>
    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
    <input type="text" name="fullName" required>
    
    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
    <input type="tel" id="phone" name="phone" required placeholder="06XXXXXXXX">
    
    <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¬Ø²:</label>
    <select id="reservationType" onchange="toggleCompanionSection()" required>
      <option value="">Ø§Ø®ØªØ±</option>
      <option value="Ù…Ù†ÙØ±Ø¯">Ù…Ù†ÙØ±Ø¯</option>
      <option value="Ù…Ø¹ Ù…Ø±Ø§ÙÙ‚ÙŠÙ†">Ù…Ø¹ Ù…Ø±Ø§ÙÙ‚ÙŠÙ†</option>
    </select>

    <div class="buttons">
      <button type="button" onclick="nextStep()">Ø§Ù„ØªØ§Ù„ÙŠ â­ï¸</button>
    </div>
  </div>

  <!-- Ø§Ù„Ø®Ø·ÙˆØ© 2 -->
  <div class="step">
    <h2>Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø­Ù„Ø©</h2>
    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø°Ù‡Ø§Ø¨:</label>
    <input type="date" id="startDate" name="startDate" required>
    
    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹ÙˆØ¯Ø©:</label>
    <input type="date" id="endDate" name="endDate" required>
    
    <div class="buttons">
      <button type="button" onclick="prevStep()">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button type="button" onclick="nextStep()">Ø§Ù„ØªØ§Ù„ÙŠ â­ï¸</button>
    </div>
  </div>

  <!-- Ø§Ù„Ø®Ø·ÙˆØ© 3 -->
  <div class="step">
    <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆÙƒØ§Ù„Ø© ÙˆØ§Ù„ÙØ±Ø¹</h2>
    <label>Ø§Ù„ÙˆÙƒØ§Ù„Ø©:</label>
    <select id="agencyDisplay" onchange="updateBranches()" required>
      <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ÙˆÙƒØ§Ù„Ø©</option>
      <option value="ÙˆÙƒØ§Ù„Ø© ØªÙ‚Ø±Øª Ù„Ù„Ø³ÙŠØ§Ø­Ø© Ùˆ Ø³ÙØ±">ÙˆÙƒØ§Ù„Ø© ØªÙ‚Ø±Øª Ù„Ù„Ø³ÙŠØ§Ø­Ø© Ùˆ Ø³ÙØ±</option>
    </select>

    <label>Ø§Ù„ÙØ±Ø¹:</label>
    <select id="branch" required>
      <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>
    </select>

    <input type="hidden" id="agencyName" name="agencyName">

    <div class="buttons">
      <button type="button" onclick="prevStep()">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button type="button" onclick="nextStep()">Ø§Ù„ØªØ§Ù„ÙŠ â­ï¸</button>
    </div>
  </div>

  <!-- Ø§Ù„Ø®Ø·ÙˆØ© 4 -->
  <div class="step" id="companionsSection" style="display:none">
    <h2>Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†</h2>
    <div id="companionsContainer"></div>
    <button type="button" onclick="addCompanion()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§ÙÙ‚</button>
    
    <div class="buttons">
      <button type="button" onclick="prevStep()">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button type="submit">Ø¥Ø±Ø³Ø§Ù„ âœ…</button>
    </div>
  </div>

</form>

<div id="message" class="popup-box">
  <h3>â³ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± <span id="countdown">10</span> Ø«ÙˆØ§Ù†ÙŠ...</h3>
  <p>âœ¨ Ù„Ø§ ØªÙ†Ø³Ù Ø§Ù„Ø§Ø³ØªØºÙØ§Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± âœ¨</p>
</div>

<div id="passportChoice" class="popup-box">
  <h3>ğŸ“„ Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ± Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ± Ø§Ù„Ø¢Ù†ØŸ</h3>
  <button onclick="location.href='upload.html'">ğŸ“¤ Ù†Ø¹Ù…ØŒ Ø£Ø±ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±</button>
  <button onclick="location.href='index.html'">â­ï¸ Ù„Ø§ØŒ Ø³Ø£Ø­Ù…Ù„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§</button>
</div>

<script>
let currentStep = 0;
const steps = document.querySelectorAll('.step');

function showStep(stepIndex) {
  steps.forEach((step,i)=>step.classList.toggle('active', i===stepIndex));
}

function nextStep() { if(currentStep<steps.length-1){ currentStep++; showStep(currentStep); } }
function prevStep() { if(currentStep>0){ currentStep--; showStep(currentStep); } }

window.addEventListener("DOMContentLoaded",()=>{
  const params = new URLSearchParams(window.location.search);
  const agencyParam = params.get("agency");
  const offerID = params.get("offerID");

  if(agencyParam){
    document.getElementById("agencyDisplay").value=agencyParam;
    document.getElementById("agencyName").value=agencyParam;
    updateBranches();
  }
  if(offerID){
    const offerInput = document.createElement("input");
    offerInput.type="hidden"; offerInput.name="offerNumber"; offerInput.value=offerID;
    document.getElementById("umrahForm").appendChild(offerInput);
  }

  showStep(currentStep);
});

// ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±
const wilayas=["Ø£Ø¯Ø±Ø§Ø±","Ø§Ù„Ø´Ù„Ù","Ø§Ù„Ø£ØºÙˆØ§Ø·","Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ","Ø¨Ø§ØªÙ†Ø©","Ø¨Ø¬Ø§ÙŠØ©","Ø¨Ø³ÙƒØ±Ø©","Ø¨Ø´Ø§Ø±","Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©","Ø§Ù„Ø¨ÙˆÙŠØ±Ø©","ØªÙ…Ù†Ø±Ø§Ø³Øª","ØªØ¨Ø³Ø©","ØªÙ„Ù…Ø³Ø§Ù†","ØªÙŠØ§Ø±Øª","ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ","Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±","Ø§Ù„Ø¬Ù„ÙØ©","Ø¬ÙŠØ¬Ù„","Ø³Ø·ÙŠÙ","Ø³Ø¹ÙŠØ¯Ø©","Ø³ÙƒÙŠÙƒØ¯Ø©","Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³","Ø¹Ù†Ø§Ø¨Ø©","Ù‚Ø§Ù„Ù…Ø©","Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©","Ø§Ù„Ù…Ø¯ÙŠØ©","Ù…Ø³ØªØºØ§Ù†Ù…","Ø§Ù„Ù…Ø³ÙŠÙ„Ø©","Ù…Ø¹Ø³ÙƒØ±","ÙˆØ±Ù‚Ù„Ø©","ÙˆÙ‡Ø±Ø§Ù†","Ø§Ù„Ø¨ÙŠØ¶","Ø¥Ù„ÙŠØ²ÙŠ","Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬","Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³","Ø§Ù„Ø·Ø§Ø±Ù","ØªÙ†Ø¯ÙˆÙ","ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª","Ø§Ù„ÙˆØ§Ø¯ÙŠ","Ø®Ù†Ø´Ù„Ø©","Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³","ØªÙŠØ¨Ø§Ø²Ø©","Ù…ÙŠÙ„Ø©","Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰","Ø§Ù„Ù†Ø¹Ø§Ù…Ø©","Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª","ØºØ±Ø¯Ø§ÙŠØ©","ØºÙ„ÙŠØ²Ø§Ù†","ØªÙ…ÙŠÙ…ÙˆÙ†","Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±","Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„","Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³","Ø¥Ù† ØµØ§Ù„Ø­","Ø¥Ù† Ù‚Ø²Ø§Ù…","ØªÙ‚Ø±Øª","Ø¬Ø§Ù†Øª","Ø§Ù„Ù…ØºÙŠØ±","Ø§Ù„Ù…Ù†ÙŠØ¹Ø©"];
const wilayaSelect = document.createElement("select"); // Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹

const agencyBranches={"ÙˆÙƒØ§Ù„Ø© ØªÙ‚Ø±Øª Ù„Ù„Ø³ÙŠØ§Ø­Ø© Ùˆ Ø³ÙØ±":["ØªÙ‚Ø±Øª","Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø©","Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³","Ø³Ø·ÙŠÙ","Ø§Ù„Ù…ØºÙŠØ±","Ø§Ù„Ø¬Ù„ÙØ©","Ø§Ù„Ù…Ø¯ÙŠØ©","Ù…Ø³ØªØºØ§Ù†Ù…","Ø¨Ø´Ø§Ø±","Ø§Ù„Ø´Ù„Ù","Ø¹Ù†Ø§Ø¨Ø©","ØªÙ…Ù†Ø±Ø§Ø³Øª","Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©","Ø¬ÙŠØ¬Ù„","ÙˆÙ‡Ø±Ø§Ù†","Ø³ÙƒÙŠÙƒØ¯Ø©","Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³"]};

function updateBranches(){
  const branchSelect=document.getElementById("branch");
  branchSelect.innerHTML='<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>';
  const selectedAgency=document.getElementById("agencyDisplay").value;
  if(selectedAgency && agencyBranches[selectedAgency]){
    agencyBranches[selectedAgency].forEach(branch=>{
      let opt=document.createElement("option");
      opt.value=branch; opt.textContent=branch;
      branchSelect.appendChild(opt);
    });
  }
  document.getElementById("agencyName").value=selectedAgency;
}

// Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†
let companionCount=0;
function addCompanion(){
  companionCount++;
  const container=document.getElementById("companionsContainer");
  const div=document.createElement("div");
  div.innerHTML=`
    <fieldset style="margin:10px 0; padding:10px; border:1px solid #ccc;">
      <legend>Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ${companionCount}</legend>
      <label>Ø§Ù„ØµÙØ©:</label>
      <select name="companionRelation${companionCount}" required>
        <option value="">Ø§Ø®ØªØ±</option>
        <option value="Ø²ÙˆØ¬Ø©">Ø²ÙˆØ¬Ø©</option>
        <option value="Ø§Ø¨Ù†">Ø§Ø¨Ù†</option>
        <option value="Ø§Ø¨Ù†Ø©">Ø§Ø¨Ù†Ø©</option>
        <option value="Ø£Ø®">Ø£Ø®</option>
        <option value="Ø£Ø®Øª">Ø£Ø®Øª</option>
        <option value="Ø£Ù…">Ø£Ù…</option>
        <option value="Ø£Ø¨">Ø£Ø¨</option>
      </select>
      <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
      <input type="text" name="companionName${companionCount}" required>
      <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</label>
      <input type="date" name="companionBirth${companionCount}" required>
      <label>ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆØ§Ø²:</label>
      <input type="date" name="companionPassport${companionCount}" required>
      <button type="button" class="remove-companion-btn" onclick="this.closest('fieldset').remove()">ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø©</button>
    </fieldset>
  `;
  container.appendChild(div);
}

// Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†
function toggleCompanionSection(){
  const type=document.getElementById("reservationType").value;
  const companionsDiv=document.getElementById("companionsSection");
  companionsDiv.style.display=(type==="Ù…Ù†ÙØ±Ø¯")?"none":"block";
}

// Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
const startDate = document.getElementById('startDate');
const endDate = document.getElementById('endDate');
if(startDate && endDate){
  startDate.addEventListener('change',()=>{ 
    endDate.min=startDate.value;
    if(endDate.value<startDate.value) endDate.value=startDate.value;
  });
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
const phoneInput=document.getElementById('phone');
phoneInput.addEventListener('input', ()=>{
  const regex=/^(05|06|07)\d{8}$/;
  if(!regex.test(phoneInput.value)) phoneInput.setCustomValidity('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­');
  else phoneInput.setCustomValidity('');
});

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
document.getElementById("umrahForm").addEventListener("submit",function(e){
  e.preventDefault();
  const form=this;
  const formData=new FormData(form);

  // Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†
  const companions=[];
  document.querySelectorAll("#companionsContainer fieldset").forEach((fieldset,i)=>{
    const relation=fieldset.querySelector(`select[name="companionRelation${i+1}"]`)?.value||"";
    const name=fieldset.querySelector(`input[name="companionName${i+1}"]`)?.value||"";
    const birth=fieldset.querySelector(`input[name="companionBirth${i+1}"]`)?.value||"";
    const passport=fieldset.querySelector(`input[name="companionPassport${i+1}"]`)?.value||"";
    if(name) companions.push(`${relation}: ${name} - Ù…ÙŠÙ„Ø§Ø¯: ${birth} - Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¬ÙˆØ§Ø²: ${passport}`);
  });
  formData.append("companions", companions.join(" | "));

  document.getElementById("message").style.display="block";
  form.style.display="none";

  fetch("https://script.google.com/macros/s/AKfycbwbxMHpUMcOfzk2CqdMbFM0EWij31KkPDMgNAQ-pqmXfVh15Rbxw5VokqhYUrOibq9-ag/exec",{
    method:"POST", body:formData
  })
  .then(res=>res.text())
  .then(res=>{
    let counter=10;
    const countdownElem=document.getElementById("countdown");
    const interval=setInterval(()=>{
      counter--;
      countdownElem.textContent=counter;
      if(counter===0){
        clearInterval(interval);
        alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!");
        document.getElementById("message").style.display="none";
        document.getElementById("passportChoice").style.display="block";
      }
    },1000);
  })
  .catch(err=>{
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: "+err.message);
    form.style.display="block";
    document.getElementById("message").style.display="none";
  });
});
</script>

</body>
</html>