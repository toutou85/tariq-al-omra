<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
  font-family:Tajawal,Arial;
  margin:0;
  background:#f3f3f3;
}

header{
  background:#8b0000;
  color:#fff;
  padding:15px;
  text-align:center;
}

.container{
  max-width:900px;
  margin:20px auto;
  padding:15px;
}

.card{
  background:#fff;
  border-radius:14px;
  padding:15px;
  margin-bottom:15px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}

.card h3{
  margin:0 0 10px;
  color:#8b0000;
}

.badge{
  display:inline-block;
  background:#eee;
  padding:6px 12px;
  border-radius:8px;
  margin:4px 0;
  font-size:14px;
}
</style>
</head>

<body>

<header>
  <h2>â­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ùƒ</h2>
</header>

<div class="container" id="offers">
  â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶...
</div>

<script>
const API =
"https://script.google.com/macros/s/AKfycbzmRIn8tTuBluEVS7-AWhTic1aFI6AcmCT4BEeaQPsG8RmDosOEScvVpGIkYJO-L5aF5w/exec";

const phone = localStorage.getItem("umrah_phone");
const box = document.getElementById("offers");

if(!phone){
  box.innerHTML = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…";
  throw "";
}

/* Ø­Ø³Ø§Ø¨ ÙØ±Ù‚ Ø§Ù„Ø£ÙŠØ§Ù… */
function diffDays(d1, d2){
  const day = 1000 * 60 * 60 * 24;
  return Math.abs((d1 - d2) / day);
}

/* Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø± */
fetch(API + "?phone=" + phone)
.then(r => r.json())
.then(user => {

  if(!user || !user.found){
    box.innerHTML = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ";
    return;
  }

  const userAirport = user.airport || "";
  const userDate = user.travel_date
    ? new Date(user.travel_date)
    : null;

  /* Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±ÙˆØ¶ */
  fetch(API + "?all=1")
  .then(r => r.json())
  .then(offers => {

    let html = "";
    let count = 0;

    offers.forEach(o => {

      if(!o.airport || !o.travel_date) return;

      const offerDate = new Date(o.travel_date);

      /* Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø·Ø§Ø± (ØªÙ‚Ø±ÙŠØ¨ÙŠØ©) */
      const sameAirport =
        o.airport.includes(userAirport) ||
        userAirport.includes(o.airport);

      /* Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® (Â±7 Ø£ÙŠØ§Ù…) */
      const closeDate =
        userDate ? diffDays(userDate, offerDate) <= 7 : true;

      if(sameAirport && closeDate){
        count++;

        html += `
          <div class="card">
            <h3>ğŸ•‹ Ø¹Ø±Ø¶ Ø¹Ù…Ø±Ø©</h3>
            <div class="badge">âœˆï¸ Ø§Ù„Ù…Ø·Ø§Ø±: ${o.airport}</div><br>
            <div class="badge">ğŸ“… Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹: ${new Date(o.travel_date).toLocaleDateString("ar-DZ")}</div><br>
            <div class="badge">ğŸ¨ Ø§Ù„ÙÙ†Ø¯Ù‚: ${o.hotel || "-"}</div><br>
            <div class="badge">â³ Ø§Ù„Ù…Ø¯Ø©: ${o.duration || "-"}</div><br>
            <div class="badge">ğŸ›ï¸ Ø§Ù„ØºØ±ÙØ©: ${o.room || "-"}</div>
          </div>
        `;
      }
    });

    box.innerHTML = count
      ? html
      : "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ù†Ø§Ø³Ø¨Ø© Ø­Ø³Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ";

  })
  .catch(()=>{
    box.innerHTML="âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø±ÙˆØ¶";
  });

})
.catch(()=>{
  box.innerHTML="âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
});
</script>

</body>
</html>
