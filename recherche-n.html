<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØµÙØ­ØªÙŠ Ø§Ù„Ø®Ø§ØµØ©</title>

<style>
body{
  font-family:Tajawal,Arial;
  margin:0;
  background:#f2f2f2;
}
header{
  background:#8b0000;
  color:#fff;
  padding:15px;
  text-align:center;
}
.container{
  max-width:560px;
  margin:30px auto;
  background:#fff;
  padding:25px;
  border-radius:18px;
}
.welcome{
  background:#f8f4ef;
  padding:15px;
  border-radius:14px;
  margin-bottom:15px;
  line-height:1.9;
}
.welcome strong{color:#8b0000}

.field{
  margin-bottom:10px;
}
.field label{
  font-size:13px;
  color:#555;
}
.field input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
}
.field input[disabled]{
  background:#eee;
}

button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:none;
  cursor:pointer;
}
.edit{background:#555;color:#fff}
.save{background:#8b0000;color:#fff}
.go{background:#00695c;color:#fff}
</style>
</head>

<body>

<header>
  <h2>ğŸ‘¤ ØµÙØ­ØªÙŠ Ø§Ù„Ø®Ø§ØµØ©</h2>
</header>

<div class="container">

<!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginBox">
  <input type="tel" id="phone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <button class="save" onclick="loadUser()">ğŸ” Ù…ØªØ§Ø¨Ø¹Ø©</button>
</div>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø± -->
<div id="userBox" style="display:none">

  <div class="welcome">
    ğŸŒ™ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ <strong id="welcomeName"></strong><br>
    Ù‡Ø°Ù‡ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„Ø¯ÙŠÙ†Ø§
  </div>

  <div class="field">
    <label>Ø§Ù„Ø§Ø³Ù…</label>
    <input id="name" disabled>
  </div>

  <div class="field">
    <label>Ø§Ù„Ù„Ù‚Ø¨</label>
    <input id="lastname" disabled>
  </div>

  <div class="field">
    <label>Ù…Ø·Ø§Ø± Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹</label>
    <input id="airport" disabled>
  </div>

  <div class="field">
    <label>Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label>
    <input id="residence" disabled>
  </div>

  <div class="field">
    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹</label>
    <input type="date" id="travel_date" disabled>
  </div>

  <button class="edit" onclick="enableEdit()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
  <button class="save" id="saveBtn" onclick="saveToSheet()" style="display:none">
    ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
  </button>

  <button class="go" onclick="goResults()">â­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</button>

</div>

</div>

<script>
const API =
"https://script.google.com/macros/s/AKfycbwaPdiqpKXpPc1_GIoVo5WV98ecIK-ay2QcQzVRqrVfezFuL-vGIziHuEJVG9TtrhAQCw/exec";

let userData=null;

function normalize(p){
  p=p.replace(/\D/g,"");
  if(p.startsWith("213"))p=p.slice(3);
  if(p.startsWith("0"))p=p.slice(1);
  return p;
}

function cleanDate(d){
  if(!d) return "";
  return d.toString().split("T")[0];
}

/* Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø± */
function loadUser(){
  const phone=normalize(document.getElementById("phone").value);
  if(!phone){ alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"); return; }

  fetch(API+"?phone="+phone)
  .then(r=>r.json())
  .then(d=>{
    if(!d || d.found!==true){
      alert("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…");
      return;
    }

    userData=d;
    localStorage.setItem("umrah_phone",phone);

    loginBox.style.display="none";
    userBox.style.display="block";

    welcomeName.innerText=d.name+" "+d.lastname;

    name.value=d.name;
    lastname.value=d.lastname;
    airport.value=d.airport;
    residence.value=d.residence;
    travel_date.value=cleanDate(d.travel_date);
  });
}

/* ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
function enableEdit(){
  document.querySelectorAll("#userBox input").forEach(i=>i.disabled=false);
  saveBtn.style.display="block";
}

/* Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Google Sheets */
function saveToSheet(){

  const data={
    phone: normalize(phone.value || userData.phone),
    name: name.value,
    lastname: lastname.value,
    airport: airport.value,
    residence: residence.value,
    travel_date: travel_date.value,
    update: "1"
  };

  fetch(API,{
    method:"POST",
    body:new URLSearchParams(data)
  })
  .then(()=>{
    alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ");
    document.querySelectorAll("#userBox input").forEach(i=>i.disabled=true);
    saveBtn.style.display="none";
  });
}

/* Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ */
function goResults(){
  location.href="results.html";
}
</script>

</body>
</html>