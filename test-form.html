<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¹Ù…Ø±Ø©</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
  font-family:Tajawal,Arial;
  margin:0;
  background:url("https://i.supaimg.com/c5d71aa9-c2b3-4263-8bd6-2f800145c063.jpg")
  center/cover fixed no-repeat;
}
.container{
  max-width:1200px;
  margin:90px auto 20px;
  background:rgba(255,255,255,.93);
  padding:20px;
  border-radius:18px
}
.filters{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin-bottom:20px
}
.filters select{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc
}
.airport-title{
  font-size:20px;
  font-weight:800;
  color:#8b0000;
  margin:15px 0
}
.slider{
  display:flex;
  gap:15px;
  overflow-x:auto
}
.offer-card{
  min-width:300px;
  background:#fff;
  padding:15px;
  border-radius:15px;
  box-shadow:0 5px 15px rgba(0,0,0,.1)
}
.offer-title{
  font-weight:800;
  color:#8b0000
}
.offer-info{
  font-size:14px;
  margin-top:8px
}
.offer-card button{
  width:100%;
  margin-top:6px;
  padding:8px;
  border:none;
  border-radius:8px;
  background:#8b0000;
  color:#fff;
  cursor:pointer
}
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  z-index:5000
}
.modal-box{
  background:#fff;
  width:90%;
  max-width:420px;
  margin:10% auto;
  padding:20px;
  border-radius:15px;
  text-align:center
}
</style>
</head>

<body>

<div class="container">

  <div id="pilgrimName"></div>
  <div id="pilgrimDetails"></div>

  <div class="filters">
    <select id="fAgency"><option value="">ğŸ¢ Ø§Ù„ÙˆÙƒØ§Ù„Ø©</option></select>
    <select id="fState"><option value="">ğŸ“ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</option></select>
    <select id="fDate"><option value="">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</option></select>
    <select id="fDuration"><option value="">â³ Ø§Ù„Ù…Ø¯Ø©</option></select>
  </div>

  <div id="offers">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶...</div>
</div>

<!-- Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨ -->
<div class="modal" id="trackModal">
  <div class="modal-box">
    <h3>ğŸ“‹ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨</h3>
    <input id="trackPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" style="width:100%;padding:10px">
    <button onclick="searchOrder()">Ø¨Ø­Ø«</button>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù†ØªØ¸Ø§Ø± -->
<div class="modal" id="loadingModal">
  <div class="modal-box">
    â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...<br>
    ğŸ¤ Ø§Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡
  </div>
</div>

<!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ -->
<div class="modal" id="detailsModal">
  <div class="modal-box">
    <h3>ğŸ“„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶</h3>
    <div id="detailsContent"></div>
    <button onclick="closeAll()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<!-- ØªØ³Ø¬ÙŠÙ„ -->
<div class="modal" id="registerModal">
  <div class="modal-box">
    <h3>ğŸ“ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
    <div id="registerContent"></div>
    <button onclick="sendEmail()">ğŸ“§ Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script>
const OFFERS_API="https://script.google.com/macros/s/AKfycbzHhKu-K6pxKLRe8b1KpiLfI39i9p0lsmUpuNBL62C1K8yozuFEnu3Pr8kRNUedFi42Tg/exec";
const TRACK_API="https://script.google.com/macros/s/AKfycby_IBGmSV8Z9YboH15QsB4lSWL1FyC6lrVLtUId1xbuIdT5zp1Zz2zbqtrdNxZLTwQgfg/exec";
const EMAIL_API="https://script.google.com/macros/s/AKfycbwIPOrlarBhvw59DOm4in1MfvLaXGARiWgeTyIYEAQw-xzWNtz8EPZgwemLxrWxieOb/exec";

let allOffers=[], currentOffers=[], currentPilgrim=null, currentOffer=null;

function closeAll(){
  document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
}

function formatDate(d){
  const x=new Date(d);
  return isNaN(x)?d:x.toLocaleDateString("ar-DZ");
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ */
fetch(OFFERS_API).then(r=>r.json()).then(d=>{
  allOffers=d;
  currentOffers=d;
  buildFilters(d);
  renderOffers(d);
});

/* Ø§Ù„ÙÙ„Ø§ØªØ± */
function buildFilters(data){
  const u=k=>[...new Set(data.map(o=>o[k]).filter(Boolean))];
  u("agency").forEach(v=>fAgency.innerHTML+=`<option>${v}</option>`);
  u("state").forEach(v=>fState.innerHTML+=`<option>${v}</option>`);
  u("duration").forEach(v=>fDuration.innerHTML+=`<option>${v}</option>`);
  u("date").forEach(v=>fDate.innerHTML+=`<option value="${v}">${formatDate(v)}</option>`);
  document.querySelectorAll(".filters select").forEach(s=>s.onchange=applyFilters);
}

function applyFilters(){
  let d=[...currentOffers];
  if(fAgency.value) d=d.filter(o=>o.agency===fAgency.value);
  if(fState.value) d=d.filter(o=>o.state===fState.value);
  if(fDuration.value) d=d.filter(o=>String(o.duration)===fDuration.value);
  if(fDate.value) d=d.filter(o=>o.date===fDate.value);
  renderOffers(d);
}

/* Ø¹Ø±Ø¶ */
function renderOffers(data){
  offers.innerHTML="";
  const byAirport={};
  data.forEach(o=>{
    byAirport[o.airport]=byAirport[o.airport]||[];
    byAirport[o.airport].push(o);
  });

  for(const a in byAirport){
    offers.innerHTML+=`
    <div class="airport-title">ğŸ›« ${a}</div>
    <div class="slider">
      ${byAirport[a].map(o=>`
        <div class="offer-card">
          <div class="offer-title">${o.offer}</div>
          <div class="offer-info">
            ğŸ“… ${formatDate(o.date)}<br>
            â³ ${o.duration} ÙŠÙˆÙ…<br>
            ğŸ“ ${o.state}<br>
            ğŸ¨ ${o.hotel}<br>
            ğŸ’° ${o.group} Ø¯Ø¬
          </div>
          <button onclick='showDetails(${JSON.stringify(o)})'>ØªÙØ§ØµÙŠÙ„</button>
          <button onclick='prepareRegister(${JSON.stringify(o)})'>ØªØ³Ø¬ÙŠÙ„</button>
        </div>
      `).join("")}
    </div>`;
  }
}

/* ØªÙØ§ØµÙŠÙ„ ÙƒØ§Ù…Ù„Ø© */
function showDetails(o){
  let h="";
  for(const k in o){
    h+=`<div><strong>${k}</strong>: ${k==="date"?formatDate(o[k]):o[k]}</div>`;
  }
  detailsContent.innerHTML=h;
  detailsModal.style.display="block";
}

/* Ù…ØªØ§Ø¨Ø¹Ø© */
function searchOrder(){
  loadingModal.style.display="block";
  fetch(TRACK_API+"?phone="+trackPhone.value)
  .then(r=>r.json())
  .then(d=>{
    closeAll();
    currentPilgrim=d;
    pilgrimName.innerText="Ù…Ø±Ø­Ø¨Ø§ ğŸ‘‹ "+d.name;
    pilgrimDetails.innerHTML=`ğŸ“ ${d.phone} | ğŸ›« ${d.airport}`;
    pilgrimName.style.display=pilgrimDetails.style.display="block";

    currentOffers=[
      ...allOffers.filter(o=>o.airport===d.airport),
      ...allOffers.filter(o=>o.airport!==d.airport)
    ];
    renderOffers(currentOffers);
  });
}

/* ØªØ³Ø¬ÙŠÙ„ */
function prepareRegister(o){
  currentOffer=o;
  registerContent.innerHTML=`${o.offer}<br>${o.group} Ø¯Ø¬`;
  registerModal.style.display="block";
}

/* Ø¥Ø±Ø³Ø§Ù„ */
function sendEmail(){
  fetch(EMAIL_API,{
    method:"POST",
    body:JSON.stringify({
      pilgrim:currentPilgrim,
      offer:currentOffer
    })
  }).then(()=>alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨"));
}
</script>

</body>
</html>

